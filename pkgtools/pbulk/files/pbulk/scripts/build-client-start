#!@SH@
# $NetBSD: build-client-start,v 1.2 2008/09/16 18:21:30 joerg Exp $

. ${PBULK_CONF:-@PBULK_CONFIG@}

set -e

if [ "${config_version}" != "@PBULK_CONFIG_VERSION@" ]; then
	echo "Your configuration has version ${config_version}."
	echo "This version of pbulk expects version @PBULK_CONFIG_VERSION@."
	exit 1
fi

for client in ${build_clients}; do
	if [ -n "${chroot_create}" -a \
	     -n "${chroot_delete}" -a \
	     -n "${chroot_dir}" ]; then
		if [ -n "${build_chroots}" -a ${build_chroots} -gt 1 ]; then
			i=1
			while true; do
				ssh $client "${chroot_create} ${chroot_dir}-${i}; PBULK_CONF=${PBULK_CONF} /usr/sbin/chroot ${chroot_dir}-${i} /bin/bash -c \"${pbuild} -c ${master_port_build} -b ${pbuild_script}\"; ${chroot_delete} ${chroot_dir}-${i}" &
				i=`expr $i + 1`
				if [ $i -gt ${build_chroots} ]; then
					break
				fi
			done
		else
			ssh $client "${chroot_create} ${chroot_dir}; PBULK_CONF=${PBULK_CONF} /usr/sbin/chroot ${chroot_dir} /bin/bash -c \"${pbuild} -c ${master_port_build} -b ${pbuild_script}\"; ${chroot_delete} ${chroot_dir}" &
		fi
	else
		ssh $client "PBULK_CONF=${PBULK_CONF} ${pbuild} -c ${master_port_build} -b ${pbuild_script}" &
	fi
done
